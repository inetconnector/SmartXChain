<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SmartX SignalR Test</title>
</head>
<body>
<h1>SmartX SignalR Hub Diagnostics</h1>
<p>
    1) Token (nur Entwicklung): <code>/token?user=Alice</code><br>
    2) Token einfügen und verbinden.
</p>
<label>JWT Token: <input id="token" size="120"/></label>
<button id="connect">Connect</button>
<div id="status"></div>
<p id="connection"></p>
<hr>
<section>
    <h2>Broadcast</h2>
    <input id="msg" placeholder="Nachricht" size="60"/>
    <button id="echo">Echo</button>
    <button id="broadcast">Broadcast</button>
</section>

<section>
    <h2>SDP Offer abrufen</h2>
    <label>Ziel ConnectionId: <input id="target" size="60"/></label>
    <button id="getOffer">Get Offer</button>
    <pre id="offer"></pre>
</section>

<h2>Log</h2>
<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.5/dist/browser/signalr.min.js"></script>
<script>
    const status = document.getElementById('status');
    const log = document.getElementById('log');

    function write(line) {
      log.textContent += line + "\n";
      log.scrollTop = log.scrollHeight;
    }

    let connection;

    document.getElementById('connect').onclick = async () => {
      const jwt = document.getElementById('token').value.trim();
      if (!jwt) return alert('Bitte Token einfügen.');

      connection = new signalR.HubConnectionBuilder()
        .withUrl("/signalrhub", { accessTokenFactory: () => jwt })
        .withAutomaticReconnect()
        .build();

      connection.on("echo", m => write("[echo] " + m));
      connection.on("broadcast", m => write("[broadcast] " + m));
      connection.on("group", (g, m) => write(`[group ${g}] ` + m));
      connection.on("ReceiveMessage", m => write("[ReceiveMessage] " + m));

      connection.onreconnecting(() => status.textContent = "Reconnecting...");
      connection.onreconnected(() => status.textContent = "Connected.");
      connection.onclose(() => status.textContent = "Closed.");

      try {
        await connection.start();
        status.textContent = "Connected.";
        write("Connected.");
        document.getElementById('connection').textContent = "ConnectionId: " + connection.connectionId;
      } catch (e) {
        status.textContent = "Error: " + e;
        console.error(e);
      }
    };

    document.getElementById('echo').onclick = async () => {
      const m = document.getElementById('msg').value;
      await connection.invoke("Echo", m);
    };
    document.getElementById('broadcast').onclick = async () => {
      const m = document.getElementById('msg').value;
      await connection.invoke("Broadcast", m);
    };

    document.getElementById('getOffer').onclick = async () => {
      const target = document.getElementById('target').value.trim();
      if (!target) return alert('Bitte Ziel ConnectionId angeben.');
      try {
        const offer = await connection.invoke("GetOffer", target, true);
        document.getElementById('offer').textContent = offer || '(empty)';
        write(`[GetOffer] ${target} -> ${offer ? 'received offer' : 'no offer'}`);
      } catch (err) {
        document.getElementById('offer').textContent = 'Error: ' + err;
        write(`[GetOffer] error ${err}`);
      }
    };
  </script>
</body>
</html>